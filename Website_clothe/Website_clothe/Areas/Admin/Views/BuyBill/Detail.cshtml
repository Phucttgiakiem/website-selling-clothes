@model Website_clothe.Models.Donmuahang


@{ 
    ViewBag.Title = "Chi tiết đơn hàng";
    var people = ViewBag.Nguoimua;
    var bill = ViewBag.Bill;
    var tongdon = ViewBag.tongdon;
    var trangthai = ViewBag.Trangthai;

}
<div class="container-fluid mt-4 px-4">
    <div class="card">
        <div class="card-header d-flex justify-content-between">
            <h4>Chi tiết đơn hàng</h4>
            <div class="card-tool">
                <button class="btn btn-info " onclick="location.href='@Url.Action("Index", "BuyBill")'">
                    <div class="text-white">Quay lại</div>
                </button>
                <a class="btn btn-danger prindbill" id="@Model.ID_Donhang" href="#">
                    <div class="text-white">In hóa đơn</div>
                </a>
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-12">
                    <div class="my-2 row">
                        <div class="col-3"><span class="fs-5" style="font-family:Arial">Mã đơn hàng:</span></div>
                        <div class="col-9"><span style="font-family:Arial">@Model.ID_Donhang</span></div>
                    </div>
                    <div class="my-2 row">
                        <div class="col-3"><span class="fs-5" style="font-family:Arial">Tên người mua hàng:</span></div>
                        <div class="col-9"><span style="font-family:Arial">@Model.Tennguoidung</span></div>
                    </div>
                    <div class="my-2 row">
                        <div class="col-3">
                            <span class="fs-5" style="font-family:Arial">Địa chỉ giao hàng:</span>
                        </div>
                        <div class="col-9">
                            <span style="font-family:Arial">@Model.DiaChi</span>
                        </div>
                    </div>
                    <div class="my-2 row">
                         <div class="col-3">
                             <span class="fs-5" style="font-family:Arial">Ngày đặt hàng:</span>
                         </div>
                        <div class="col-9">
                            <span style="font-family:Arial">@Model.Ngaytao.Value.ToString("dd/MM/yyyy")</span>
                        </div>
                    </div>
                    <div class="my-2 row">
                        <div class="col-3">
                            <span class="fs-5" style="font-family:Arial">Email:</span>
                        </div>
                        <div class="col-9">
                            <span style="font-family:Arial">@people.Email</span>
                        </div>
                    </div>
                    <div class="my-2 row">
                        <div class="col-3">
                            <span class="fs-5" style="font-family:Arial">Số điện thoại:</span>
                        </div>
                        <div class="col-9">
                            <span style="font-family:Arial">@people.SoDT</span>
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    <div class="row">
                        <div class="col-12">
                            <h5 class="my-5">Danh sách sản phẩm mua</h5>
                        </div>
                        <div class="col-12">
                            <table class="table text-center">
                                <thead>
                                    <tr>
                                        <th>Mã sản phẩm</th>
                                        <th>Tên sản phẩm</th>
                                        <th>Size</th>
                                        <th>Màu</th>
                                        <th>Số lượng</th>
                                        <th>Đơn giá</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in bill)
                                    {
                                        <tr>
                                            <td>@item.masanpham</td>
                                            <td>@item.tensanpham</td>
                                            <td>@item.size</td>
                                            <td class="d-flex justify-content-center">
                                                <div style="border:2px solid rgb(52, 42, 42);border-radius:20px; width:30px;height:30px;background-color:@item.mausac;"></div>
                                            </td>
                                            <td>@item.soluong</td>
                                            <td>@item.dongia đ</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        <div class="col-12">
                            <div class="row">
                                <div class="col-9">
                                    <span class="fs-5" style="font-family:Arial">Tổng đơn:</span>
                                </div>
                                <div class="col-3 d-flex justify-content-end align-items-center">
                                    <span style="font-family:Arial;margin-right:25px">@tongdon đ</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 my-3">
                            <div class="col-12 py-2">
                                <span class="fs-5" style="font-family:Arial">Trạng thái đơn hàng:</span>
                            </div>
                            <div class="col-12">
                                <select class="form-select" id="changestatus">
                                    @foreach(var item in trangthai)
                                    {
                                        if(item.ID_TrangThai == Model.ID_Trangthai)
                                        {
                                            <option value="@item.ID_TrangThai" selected disabled>@item.TenTrangThai</option>
                                        }
                                        else {
                                            <option value="@item.ID_TrangThai">@item.TenTrangThai</option>
                                        }
                                    }
                                </select>
                            </div>
                        </div>
                        <div class="col-12 my-3 d-flex justify-content-center align-items-center">
                            <button type="button" class="btn btn-success btn-submit" id="@Model.ID_Donhang">Cập nhật đơn hàng</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    $(document).ready(function () {
        
        $('body').on('click', '.btn-submit', function () {
            
            var id = this.id
            var lis = $('#changestatus').val();

            $.ajax({
                url: '/Admin/BuyBill/Changeofstatusbill',
                type: 'POST',
                data: {
                    id : id,
                    valueofbill : lis
                },
                success: function (rs) {
                    if (rs.success) {
                        alert('Trạng thái đơn hàng được cập nhật')
                        // Hủy thuộc tính disabled của tất cả các options
                        $('#changestatus option').prop('disabled', false);

                        // Lấy trạng thái mới đã cập nhật
                        var updatedStatus = lis;

                        // Tìm option tương ứng với trạng thái mới và làm cho nó selected và disabled
                        $('#changestatus option[value="' + updatedStatus + '"]').prop('selected', true).prop('disabled', true);
                    }
                }
            })
        })
        $('body').on('click', '.prindbill', function (e) {
            e.preventDefault
            var id = $(this).attr('id');
            $.ajax({
                url: '/Admin/BuyBill/Generatepdf',
                type: 'GET',
                data: { idbill: id },
                success: function (response) {

                    location.href = "/Resource/Pdf/" + response;
                },
                error: function (error) {
                    console.log(error);
                }
            });
        })
    })
</script>
